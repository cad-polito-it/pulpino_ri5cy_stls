.global test_csr
.text

test_csr:

	# ABI prologue
	addi sp, sp, -112     # allocate 112 bytes on the stack
	sw x1, 104(sp)        # save return address
	#sw x9, 96(sp)         # save callee-saved registers
	#sw x10, 88(sp)
	#sw x18, 80(sp)
	#sw x19, 72(sp)
	#sw x20, 64(sp)
	#sw x21, 56(sp)
	#sw x22, 48(sp)
	#sw x23, 40(sp)
	#sw x24, 32(sp)
	#sw x25, 24(sp)
	#sw x26, 16(sp)
	#sw x27, 8(sp)
	addi s0, sp, 112     # set up s0 to point to start of stack frame
	li t0, 0x00104000    # save stack pointer
	sw sp, 0(t0)

##############################################################################
#                             _____  _____ _____                             #
#                            / ____|/ ____|  __ \                            #
#                           | |    | (___ | |__) |                           #
#                           | |     \___ \|  _  /                            #
#                           | |____ ____) | | \ \                            #
#                            \_____|_____/|_|  \_\                           #
#                                                                            #
##############################################################################

	# MATS+ on CSRs
	li                  x1,     0x0
	li                  x2,     0xffffffff

	# Write DBG[0]
	csrw                768,    x1
	csrw                773,    x1
	csrw                833,    x1
	csrw                834,    x1
	csrw                1920,   x1
	csrw                1921,   x1
	csrw                1922,   x1
	csrw                1923,   x1
	csrw                1924,   x1
	csrw                1925,   x1
	csrw                1926,   x1
	csrw                1927,   x1
	csrw                1928,   x1
	csrw                1929,   x1
	csrw                1930,   x1
	csrw                1931,   x1
	csrw                1932,   x1
	csrw                1933,   x1
	csrw                1934,   x1
	csrw                1935,   x1
	csrw                1936,   x1
	csrw                1937,   x1
	csrw                1938,   x1
	csrw                1939,   x1
	csrw                1940,   x1
	csrw                1941,   x1
	csrw                1942,   x1
	csrw                1943,   x1
	csrw                1944,   x1
	csrw                1945,   x1
	csrw                1946,   x1
	csrw                1947,   x1
	csrw                1948,   x1
	csrw                1949,   x1
	csrw                1950,   x1
	csrw                1951,   x1
	csrw                1952,   x1
	csrw                1953,   x1
	csrw                1968,   x1
	csrw                1969,   x1
	csrw                1970,   x1
	csrw                1971,   x1
	csrw                1972,   x1
	csrw                1973,   x1
	csrw                1974,   x1
	csrw                1975,   x1
	csrw                3088,   x1
	csrw                20,     x1
	csrw                3860,   x1

	# For each register, read DBG[0], write DBG[1]
	csrr                x3,     768
	sw                  x3,     0(x0)
	csrw                768,    x2
	csrr                x3,     773
	sw                  x3,     0(x0)
	csrw                773,    x2
	csrr                x3,     833
	sw                  x3,     0(x0)
	csrw                833,    x2
	csrr                x3,     834
	sw                  x3,     0(x0)
	csrw                834,    x2
	csrr                x3,     1920
	sw                  x3,     0(x0)
	csrw                1920,   x2
	csrr                x3,     1921
	sw                  x3,     0(x0)
	csrw                1921,   x2
	csrr                x3,     1922
	sw                  x3,     0(x0)
	csrw                1922,   x2
	csrr                x3,     1923
	sw                  x3,     0(x0)
	csrw                1923,   x2
	csrr                x3,     1924
	sw                  x3,     0(x0)
	csrw                1924,   x2
	csrr                x3,     1925
	sw                  x3,     0(x0)
	csrw                1925,   x2
	csrr                x3,     1926
	sw                  x3,     0(x0)
	csrw                1926,   x2
	csrr                x3,     1927
	sw                  x3,     0(x0)
	csrw                1927,   x2
	csrr                x3,     1928
	sw                  x3,     0(x0)
	csrw                1928,   x2
	csrr                x3,     1929
	sw                  x3,     0(x0)
	csrw                1929,   x2
	csrr                x3,     1930
	sw                  x3,     0(x0)
	csrw                1930,   x2
	csrr                x3,     1931
	sw                  x3,     0(x0)
	csrw                1931,   x2
	csrr                x3,     1932
	sw                  x3,     0(x0)
	csrw                1932,   x2
	csrr                x3,     1933
	sw                  x3,     0(x0)
	csrw                1933,   x2
	csrr                x3,     1934
	sw                  x3,     0(x0)
	csrw                1934,   x2
	csrr                x3,     1935
	sw                  x3,     0(x0)
	csrw                1935,   x2
	csrr                x3,     1936
	sw                  x3,     0(x0)
	csrw                1936,   x2
	csrr                x3,     1937
	sw                  x3,     0(x0)
	csrw                1937,   x2
	csrr                x3,     1938
	sw                  x3,     0(x0)
	csrw                1938,   x2
	csrr                x3,     1939
	sw                  x3,     0(x0)
	csrw                1939,   x2
	csrr                x3,     1940
	sw                  x3,     0(x0)
	csrw                1940,   x2
	csrr                x3,     1941
	sw                  x3,     0(x0)
	csrw                1941,   x2
	csrr                x3,     1942
	sw                  x3,     0(x0)
	csrw                1942,   x2
	csrr                x3,     1943
	sw                  x3,     0(x0)
	csrw                1943,   x2
	csrr                x3,     1944
	sw                  x3,     0(x0)
	csrw                1944,   x2
	csrr                x3,     1945
	sw                  x3,     0(x0)
	csrw                1945,   x2
	csrr                x3,     1946
	sw                  x3,     0(x0)
	csrw                1946,   x2
	csrr                x3,     1947
	sw                  x3,     0(x0)
	csrw                1947,   x2
	csrr                x3,     1948
	sw                  x3,     0(x0)
	csrw                1948,   x2
	csrr                x3,     1949
	sw                  x3,     0(x0)
	csrw                1949,   x2
	csrr                x3,     1950
	sw                  x3,     0(x0)
	csrw                1950,   x2
	csrr                x3,     1951
	sw                  x3,     0(x0)
	csrw                1951,   x2
	csrr                x3,     1952
	sw                  x3,     0(x0)
	csrw                1952,   x2
	csrr                x3,     1953
	sw                  x3,     0(x0)
	csrw                1953,   x2
	csrr                x3,     1968
	sw                  x3,     0(x0)
	csrw                1968,   x2
	csrr                x3,     1969
	sw                  x3,     0(x0)
	csrw                1969,   x2
	csrr                x3,     1970
	sw                  x3,     0(x0)
	csrw                1970,   x2
	csrr                x3,     1971
	sw                  x3,     0(x0)
	csrw                1971,   x2
	csrr                x3,     1972
	sw                  x3,     0(x0)
	csrw                1972,   x2
	csrr                x3,     1973
	sw                  x3,     0(x0)
	csrw                1973,   x2
	csrr                x3,     1974
	sw                  x3,     0(x0)
	csrw                1974,   x2
	csrr                x3,     1975
	sw                  x3,     0(x0)
	csrw                1975,   x2
	csrr                x3,     3088
	sw                  x3,     0(x0)
	csrw                3088,   x2
	csrr                x3,     20
	sw                  x3,     0(x0)
	csrw                20,     x2
	csrr                x3,     3860
	sw                  x3,     0(x0)
	csrw                3860,   x2

	# For each register, read DBG[1], write DBG[0]
	csrr                x3,     768
	sw                  x3,     0(x0)
	csrw                768,    x1
	csrr                x3,     773
	sw                  x3,     0(x0)
	csrw                773,    x1
	csrr                x3,     833
	sw                  x3,     0(x0)
	csrw                833,    x1
	csrr                x3,     834
	sw                  x3,     0(x0)
	csrw                834,    x1
	csrr                x3,     1920
	sw                  x3,     0(x0)
	csrw                1920,   x1
	csrr                x3,     1921
	sw                  x3,     0(x0)
	csrw                1921,   x1
	csrr                x3,     1922
	sw                  x3,     0(x0)
	csrw                1922,   x1
	csrr                x3,     1923
	sw                  x3,     0(x0)
	csrw                1923,   x1
	csrr                x3,     1924
	sw                  x3,     0(x0)
	csrw                1924,   x1
	csrr                x3,     1925
	sw                  x3,     0(x0)
	csrw                1925,   x1
	csrr                x3,     1926
	sw                  x3,     0(x0)
	csrw                1926,   x1
	csrr                x3,     1927
	sw                  x3,     0(x0)
	csrw                1927,   x1
	csrr                x3,     1928
	sw                  x3,     0(x0)
	csrw                1928,   x1
	csrr                x3,     1929
	sw                  x3,     0(x0)
	csrw                1929,   x1
	csrr                x3,     1930
	sw                  x3,     0(x0)
	csrw                1930,   x1
	csrr                x3,     1931
	sw                  x3,     0(x0)
	csrw                1931,   x1
	csrr                x3,     1932
	sw                  x3,     0(x0)
	csrw                1932,   x1
	csrr                x3,     1933
	sw                  x3,     0(x0)
	csrw                1933,   x1
	csrr                x3,     1934
	sw                  x3,     0(x0)
	csrw                1934,   x1
	csrr                x3,     1935
	sw                  x3,     0(x0)
	csrw                1935,   x1
	csrr                x3,     1936
	sw                  x3,     0(x0)
	csrw                1936,   x1
	csrr                x3,     1937
	sw                  x3,     0(x0)
	csrw                1937,   x1
	csrr                x3,     1938
	sw                  x3,     0(x0)
	csrw                1938,   x1
	csrr                x3,     1939
	sw                  x3,     0(x0)
	csrw                1939,   x1
	csrr                x3,     1940
	sw                  x3,     0(x0)
	csrw                1940,   x1
	csrr                x3,     1941
	sw                  x3,     0(x0)
	csrw                1941,   x1
	csrr                x3,     1942
	sw                  x3,     0(x0)
	csrw                1942,   x1
	csrr                x3,     1943
	sw                  x3,     0(x0)
	csrw                1943,   x1
	csrr                x3,     1944
	sw                  x3,     0(x0)
	csrw                1944,   x1
	csrr                x3,     1945
	sw                  x3,     0(x0)
	csrw                1945,   x1
	csrr                x3,     1946
	sw                  x3,     0(x0)
	csrw                1946,   x1
	csrr                x3,     1947
	sw                  x3,     0(x0)
	csrw                1947,   x1
	csrr                x3,     1948
	sw                  x3,     0(x0)
	csrw                1948,   x1
	csrr                x3,     1949
	sw                  x3,     0(x0)
	csrw                1949,   x1
	csrr                x3,     1950
	sw                  x3,     0(x0)
	csrw                1950,   x1
	csrr                x3,     1951
	sw                  x3,     0(x0)
	csrw                1951,   x1
	csrr                x3,     1952
	sw                  x3,     0(x0)
	csrw                1952,   x1
	csrr                x3,     1953
	sw                  x3,     0(x0)
	csrw                1953,   x1
	csrr                x3,     1968
	sw                  x3,     0(x0)
	csrw                1968,   x1
	csrr                x3,     1969
	sw                  x3,     0(x0)
	csrw                1969,   x1
	csrr                x3,     1970
	sw                  x3,     0(x0)
	csrw                1970,   x1
	csrr                x3,     1971
	sw                  x3,     0(x0)
	csrw                1971,   x1
	csrr                x3,     1972
	sw                  x3,     0(x0)
	csrw                1972,   x1
	csrr                x3,     1973
	sw                  x3,     0(x0)
	csrw                1973,   x1
	csrr                x3,     1974
	sw                  x3,     0(x0)
	csrw                1974,   x1
	csrr                x3,     1975
	sw                  x3,     0(x0)
	csrw                1975,   x1
	csrr                x3,     3088
	sw                  x3,     0(x0)
	csrw                3088,   x1
	csrr                x3,     20
	sw                  x3,     0(x0)
	csrw                20,     x1
	csrr                x3,     3860
	sw                  x3,     0(x0)
	csrw                3860,   x1

	# Read debug registers
	csrr                x3,     0
	sw                  x3,     0(x0)
	csrr                x3,     4
	sw                  x3,     0(x0)
	csrr                x3,     8
	sw                  x3,     0(x0)
	csrr                x3,     12
	sw                  x3,     0(x0)
	csrr                x3,     64
	sw                  x3,     0(x0)
	csrr                x3,     68
	sw                  x3,     0(x0)
	csrr                x3,     72
	sw                  x3,     0(x0)
	csrr                x3,     76
	sw                  x3,     0(x0)
	csrr                x3,     80
	sw                  x3,     0(x0)
	csrr                x3,     84
	sw                  x3,     0(x0)
	csrr                x3,     88
	sw                  x3,     0(x0)
	csrr                x3,     92
	sw                  x3,     0(x0)
	csrr                x3,     96
	sw                  x3,     0(x0)
	csrr                x3,     100
	sw                  x3,     0(x0)
	csrr                x3,     104
	sw                  x3,     0(x0)
	csrr                x3,     108
	sw                  x3,     0(x0)
	csrr                x3,     112
	sw                  x3,     0(x0)
	csrr                x3,     116
	sw                  x3,     0(x0)
	csrr                x3,     120
	sw                  x3,     0(x0)
	csrr                x3,     124
	sw                  x3,     0(x0)

	# ABI epilogue
	li t0, 0x00104000    # restore stack pointer
	lw sp, 0(t0)
	#lw x27, 8(sp)        # restore callee-saved registers
	#lw x26, 16(sp)
	#lw x25, 24(sp)
	#lw x24, 32(sp)
	#lw x23, 40(sp)
	#lw x22, 48(sp)
	#lw x21, 56(sp)
	#lw x20, 64(sp)
	#lw x19, 72(sp)
	#lw x18, 80(sp)
	#lw x10, 88(sp)
	#lw x9, 96(sp)
	lw x1, 104(sp)       # restore return address
	addi sp, sp, 112     # deallocate stack space
	jr ra                # return to caller
